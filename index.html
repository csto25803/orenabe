<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ä¿ºãŸã¡ã‚’ç…®ã‚‹ã‹æ¨ã¦ã‚‹ã‹æ±ºã‚ã¦ãã‚Œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* (CSSã¯ä¸€éƒ¨å¤‰æ›´ãƒ»è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™) */
    :root { --header-height: 60px; }
    body {
      font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background: linear-gradient(to bottom, #ffe4c4, #fffacd);
      margin: 0; padding-top: var(--header-height); color: #333;
    }
    header {
      display: flex; justify-content: space-between; align-items: center; padding: 1rem;
      background-color: #ff7f50; color: white; position: fixed; top: 0; left: 0;
      width: 100%; box-sizing: border-box; z-index: 1000;
    }
    h1 { margin: 0; font-size: 1.2rem; cursor: pointer; }
    .menu-toggle { font-size: 1.5rem; cursor: pointer; }
    nav {
      display: none; flex-direction: column; background-color: #ffa07a;
      position: absolute; top: var(--header-height); right: 10px;
      border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    nav.open { display: flex; }
    nav a { padding: 10px 15px; color: white; text-decoration: none; font-weight: bold; cursor: pointer; }
    .page-container { max-width: 900px; margin: auto; padding: 1rem; }
    .hidden { display: none; }
    .input-area {
      display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;
      background: white; padding: 1rem; border-radius: 8px;
    }
    .input-area input, .input-area select, .input-area button {
      padding: 0.5rem; border-radius: 8px; border: 1px solid #ccc; flex-grow: 1;
    }
    .input-area button { flex-grow: 0; background-color: #ff7f50; color: white; cursor: pointer; }
    #drop-zone {
      border: 2px dashed #ff8c00; padding: 1rem; margin-top: 1rem; text-align: center;
      background: #fff5e1; border-radius: 8px; transition: background-color 0.2s;
    }
    #drop-zone.dragover { background-color: #ffddab; }
    .card-grid { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; }
    .card {
      background: #fffaf0; border: 2px solid #deb887; border-radius: 10px; padding: 1rem;
      width: 200px; box-shadow: 2px 2px 6px rgba(0,0,0,0.2); text-align: center;
      display: flex; flex-direction: column; justify-content: space-between;
    }
    .card.near-expiry { border-color: #f0ad4e; background-color: #fcf8e3; }
    .card.expired { border-color: #d9534f; background-color: #f2dede; opacity: 0.8; }
    .card img {
      width: 80px; height: 80px; object-fit: cover; border-radius: 50%;
      background: #eee; margin: 0 auto 0.5rem auto; border: 2px solid white;
    }
    .card .dialog { font-size: 0.9em; font-style: italic; color: #555; min-height: 50px; }
    .card button { margin: 0.25rem; padding: 0.4rem 0.8rem; border: none; border-radius: 6px; cursor: pointer; background-color: #ffb347; color: white; }
    .diary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;}
    .diary-header h2, #analytics-page h2 { margin: 0; }
    #diary-page details { background: #fff; border-radius: 8px; margin-bottom: 1em; border: 1px solid #ddd; }
    #diary-page summary { padding: 1em; font-weight: bold; font-size: 1.1em; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
    .diary-group-heading { font-size: 1.5em; margin: 1.5em 0 0.5em 0; border-bottom: 2px solid #ff7f50; padding-bottom: 0.3em; display: flex; align-items: center; gap: 10px; }
    .diary-group-heading img { width: 30px; height: 30px; }
    .log-entry { padding: 1.5em; border-top: 1px solid #eee; display: flex; gap: 1.5em; align-items: flex-start; }
    .log-entry img { width: 60px; height: 60px; object-fit: cover; border-radius: 50%; background: #eee; flex-shrink: 0; }
    .log-details { flex-grow: 1; }
    .diary-table { width: 100%; border-collapse: collapse; margin-bottom: 1em; }
    .diary-table th, .diary-table td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
    .diary-table th { background-color: #f9f9f9; }
    .status-dot { font-size: 1.2em; vertical-align: middle; margin-right: 0.5em; }
    .cooked { color: #28a745; } .disposed { color: #dc3545; }
    .diary-conversation { background-color: #fdfdfd; padding: 1em; border-radius: 5px; border: 1px solid #f0f0f0; }
    .dialog-title { font-weight: bold; margin-top: 0; margin-bottom: 0.8em; font-size: 0.9em; color: #555; }
    .dialog-line { margin: 0.5em 0; }
    .dialog-label { display: inline-block; background-color: #e7e7e7; color: #333; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-right: 1em; width: 40px; text-align: center; }
    .clear-history-btn { display: block; margin: 1rem auto; padding: 0.5rem 1rem; border: 1px solid #dc3545; background-color: #f8d7da; color: #721c24; border-radius: 5px; cursor: pointer; }

    .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
    .analytics-card { background: white; padding: 1.5em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .analytics-card h3 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 0.5em; display: flex; justify-content: space-between; align-items: center; }
    .analytics-card p { font-size: 2.5em; font-weight: bold; text-align: center; color: #ff7f50; margin: 0.5em 0; }
    
    #toast-container {
        position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex;
        flex-direction: column; gap: 10px; pointer-events: none;
    }
    .toast {
        background-color: #28a745; color: white; padding: 15px 20px; border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2); opacity: 0;
        transform: translateY(120%); transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.error { background-color: #dc3545; }
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 10000;
        display: flex; justify-content: center; align-items: center;
        opacity: 0; transition: opacity 0.3s; pointer-events: none;
    }
    .modal-overlay.show { opacity: 1; pointer-events: all; }
    .modal-content {
        background: white; padding: 2em; border-radius: 8px; text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        transform: scale(0.9); transition: transform 0.3s;
    }
    .modal-overlay.show .modal-content { transform: scale(1); }
    .modal-content p { margin: 0 0 1.5em 0; }
    .modal-buttons button { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; margin: 0 10px; }
    #modal-confirm-btn { background: #dc3545; color: white; }
    #modal-cancel-btn { background: #ccc; }

    footer { text-align: center; padding: 2rem 0; font-size: 0.8em; color: #666; }
  </style>
</head>
<body>
  <header>
    <h1 onclick="showPage('home')">ä¿ºãŸã¡ã‚’ç…®ã‚‹ã‹æ¨ã¦ã‚‹ã‹æ±ºã‚ã¦ãã‚Œ</h1>
    <div class="menu-toggle" onclick="toggleMenu()">â˜°</div>
    <nav id="nav-menu">
      <a onclick="showPage('home')">ãƒ›ãƒ¼ãƒ </a>
      <a onclick="showPage('diary-page')">æ—¥è¨˜ã¾ã¨ã‚</a>
      <a onclick="showPage('analytics-page')">ãƒ‡ãƒ¼ã‚¿åˆ†æ</a>
    </nav>
  </header>

  <div id="home" class="page-container">
    <div class="input-area">
      <input type="text" id="name" placeholder="é£Ÿæå"><input type="date" id="expiry">
      <select id="type">
        <option value="vegetable">é‡èœ</option><option value="meat">è‚‰</option><option value="fish">é­š</option>
        <option value="egg">åµ</option><option value="dairy">ä¹³è£½å“</option><option value="snack">ãŠè“å­</option>
        <option value="other">ãã®ä»–</option>
      </select>
      <button id="add-btn" type="button">è¿½åŠ </button>
    </div>
    <div id="drop-zone">ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
    <div id="ingredient-list" class="card-grid"></div>
  </div>

  <div id="diary-page" class="page-container hidden">
    <div class="diary-header">
      <h2>ğŸ“ æ—¥è¨˜ã¾ã¨ã‚</h2>
      <div>
        <label for="sort-diary">ä¸¦ã³æ›¿ãˆ:</label>
        <select id="sort-diary" onchange="displayDiary()">
          <option value="processedDate">å‡¦ç†ãŒæ–°ã—ã„é †</option>
          <option value="type">ç¨®é¡åˆ¥</option>
        </select>
      </div>
    </div>
    <div id="diary-summary"></div>
    <button class="clear-history-btn" onclick="showClearConfirmModal()">å…¨ãƒ‡ãƒ¼ã‚¿ã¨å±¥æ­´ã‚’å‰Šé™¤</button>
  </div>

  <div id="analytics-page" class="page-container hidden">
    <div class="diary-header"><h2>ğŸ“Š ãƒ‡ãƒ¼ã‚¿åˆ†æ</h2></div>
    <div class="analytics-grid">
      <div class="analytics-card">
        <h3>å¹³å‡å‡¦ç†æ—¥æ•°</h3>
        <p id="avg-processing-time">- æ—¥</p>
      </div>
      <div class="analytics-card">
        <h3>
          <span>å‡¦ç†ãƒˆãƒ¬ãƒ³ãƒ‰</span>
          <select id="trend-period" onchange="displayAnalytics()">
            <option value="7days">éå»7æ—¥é–“</option>
            <option value="30days">éå»30æ—¥é–“</option>
            <option value="byMonth">æœˆåˆ¥ (å¹´é–“)</option>
          </select>
        </h3>
        <canvas id="trend-chart"></canvas>
      </div>
      <div class="analytics-card" style="grid-column: 1 / -1;">
        <h3>é£Ÿæç¨®é¡åˆ¥ å‡¦ç†çµ±è¨ˆ</h3>
        <canvas id="type-stats-chart"></canvas>
      </div>
    </div>
  </div>

  <div id="toast-container"></div>
  <div id="confirm-modal" class="modal-overlay">
    <div class="modal-content">
      <p>æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ<br>ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
      <div class="modal-buttons">
        <button id="modal-confirm-btn">å‰Šé™¤ã™ã‚‹</button><button id="modal-cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <footer><p>Â© 2025 å†·è”µåº«äººæ ¼ç ”ç©¶æ‰€</p></footer>

  <script>
    let droppedImageData = null;
    let trendChartInstance = null;
    let typeStatsChartInstance = null;
    const personalities = {
      vegetable: "ãŠã£ã¨ã‚Š", meat: "ç†±è¡€æ¼¢", fish: "ã‚¯ãƒ¼ãƒ«", egg: "ç¹Šç´°", dairy: "ãƒã‚¬ãƒ†ã‚£ãƒ–", snack: "å…ƒæ°—ã£å­", other: ["è¬ã‚ã„ãŸ", "çš®è‚‰å±‹", "ç„¡å£"]
    };

    function toggleMenu() { document.getElementById("nav-menu").classList.toggle("open"); }
    function showPage(pageId) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        document.querySelectorAll('.page-container').forEach(p => p.classList.add('hidden'));
        const page = document.getElementById(pageId);
        if (page) {
            page.classList.remove('hidden');
            if (pageId === 'analytics-page') displayAnalytics();
        }
        if (document.getElementById("nav-menu").classList.contains("open")) toggleMenu();
    }
    
    // â˜…â˜…â˜…â˜…â˜… BUG FIX: ã“ã®é–¢æ•°ãŒæŠœã‘ã¦ã„ãŸã®ãŒåŸå› ã§ã—ãŸ â˜…â˜…â˜…â˜…â˜…
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
      }, 3000);
    }
    
    function getDaysLeft(expiry) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const date = new Date(expiry);
        date.setHours(0, 0, 0, 0);
        return Math.ceil((date - today) / (1000 * 60 * 60 * 24));
    }
    function generateDialog(name, type, daysLeft) {
        const style = Array.isArray(personalities[type]) ? personalities[type][Math.floor(Math.random() * personalities[type].length)] : personalities[type] || "æ™®é€š";
        if (daysLeft < 0) return `${name}ï¼š${getDialogByStyle(style, "expired")}`;
        if (daysLeft === 0) return `${name}ï¼š${getDialogByStyle(style, "today")}`;
        return `${name}ï¼š${getDialogByStyle(style, "remaining", daysLeft)}`;
    }
    function getDialogByStyle(style, status, daysLeft = 0) {
        const dialogs = {
            expired: { ç†±è¡€æ¼¢: "ãã£â€¦ã‚‚ã†é–“ã«åˆã‚ãªã„ã ã¨ï¼ï¼Ÿ", ã‚¯ãƒ¼ãƒ«: "â€¦ã‚‚ã†é…ã„ã‹ã€‚", ç¹Šç´°: "ã²ã£â€¦ã‚‚ã†ã ã‚ãªã®ï¼Ÿ", ãƒã‚¬ãƒ†ã‚£ãƒ–: "ã»ã‚‰ã­ã€ã‚„ã£ã±ã‚Šãƒ€ãƒ¡ã ã£ãŸã€‚", å…ƒæ°—ã£å­: "ã†ã‚ãƒ¼ã‚“ï¼è³å‘³æœŸé™åˆ‡ã‚Œã¡ã‚ƒã£ãŸãƒ¼ï¼", ãŠã£ã¨ã‚Š: "ã‚ã‚‰ã€œæ®‹å¿µã­ã‡â€¦", è¬ã‚ã„ãŸ: "æ™‚ã¯æº€ã¡ãŸâ€¦ã‹ã€‚", çš®è‚‰å±‹: "ã©ã†ã›èª°ã‚‚é£Ÿã¹ã‚„ã—ãªã„ã¨æ€ã£ã¦ãŸã‚ˆã€‚", ç„¡å£: "â€¦â€¦â€¦â€¦ã€‚" },
            today: { ç†±è¡€æ¼¢: "ä»Šæ—¥ãŒå‹è² ã®æ—¥ã ï¼ã‚„ã£ã¦ã‚„ã‚‹ãœï¼", ã‚¯ãƒ¼ãƒ«: "æ±ºç€ã‚’ã¤ã‘ã‚ˆã†ã€‚", ç¹Šç´°: "ä»Šæ—¥ã—ã‹ãªã„â€¦é ‘å¼µã‚‰ãªãã‚ƒâ€¦ï¼", ãƒã‚¬ãƒ†ã‚£ãƒ–: "ä»Šæ—¥ã§çµ‚ã‚ã‚Šã‹â€¦ç§ã€‚", å…ƒæ°—ã£å­: "ã„ã‚ˆã„ã‚ˆä»Šæ—¥ï¼æ¥½ã—ã¿ã€œâ™ª", ãŠã£ã¨ã‚Š: "ä»Šæ—¥ã¯ãªã‚“ã ã‹ãƒ‰ã‚­ãƒ‰ã‚­ã™ã‚‹ã‚ã€œ", è¬ã‚ã„ãŸ: "é‹å‘½ã®æ—¥ã ãªâ€¦ã€‚", çš®è‚‰å±‹: "ã›ã„ãœã„ä»Šæ—¥ã®å†…ã«ä½¿ã„åˆ‡ã‚‹ã‚“ã ãªã€‚", ç„¡å£: "â€¦ä»Šæ—¥ã ã€‚" },
            remaining: { ç†±è¡€æ¼¢: `ã‚ã¨${daysLeft}æ—¥ã‹ï¼æ°—åˆã„å…¥ã‚Œã¦ã„ã“ã†ãœï¼`, ã‚¯ãƒ¼ãƒ«: `æ®‹ã‚Š${daysLeft}æ—¥ã€‚æ‚ªããªã„ã€‚`, ç¹Šç´°: `ã‚ã¨${daysLeft}æ—¥â€¦ãƒ‰ã‚­ãƒ‰ã‚­ã™ã‚‹â€¦`, ãƒã‚¬ãƒ†ã‚£ãƒ–: `ã©ã†ã›ã‚ã¨${daysLeft}æ—¥ã§æ¨ã¦ã‚‰ã‚Œã‚‹ã‚“ã§ã—ã‚‡â€¦`, å…ƒæ°—ã£å­: `ã‚ã¨${daysLeft}æ—¥ï¼ã¾ã ã¾ã å…ƒæ°—ã ã‚ˆã€œï¼`, ãŠã£ã¨ã‚Š: `ã‚ã¨${daysLeft}æ—¥ã€ã‚†ã£ãã‚Šã—ã¦ã„ã“ã†ã­ã€œ`, è¬ã‚ã„ãŸ: `â€¦${daysLeft}æ—¥å¾Œã€ä½•ã‹ãŒèµ·ã“ã‚‹ã€‚`, çš®è‚‰å±‹: `ã‚ã¨${daysLeft}æ—¥ã‹ã€‚æ—©ãä½¿ã£ã¦ãã‚Œãªã„ã‹ãªã€‚`, ç„¡å£: `â€¦ã‚ã¨${daysLeft}æ—¥ã€‚` }
        };
        return dialogs[status][style] || "ã‚ˆã‚ã—ãã­ï¼";
    }
    function getGratitudeMessage(name, type) {
        const style = Array.isArray(personalities[type]) ? personalities[type][Math.floor(Math.random() * personalities[type].length)] : personalities[type] || "æ™®é€š";
        const message = { ç†±è¡€æ¼¢: "ã†ãŠãŠã£ï¼æœ€é«˜ã®æ–™ç†ã«ã—ã¦ãã‚Œã‚ˆãªï¼", ã‚¯ãƒ¼ãƒ«: "ã‚­ãƒŸã«èª¿ç†ã•ã‚Œã‚‹ãªã‚‰æœ¬æœ›ã ã€‚", ç¹Šç´°: "ã‚ã€ç§ã§ã„ã„ã®â€¦ï¼Ÿç¾å‘³ã—ãã—ã¦ã­â€¦ï¼", ãƒã‚¬ãƒ†ã‚£ãƒ–: "ã©ã†ã›ç¾å‘³ã—ããªã„ã‚“ã ã‚ã†ã‘ã©â€¦ã¾ã‚ã€ã„ã„ã‚ˆã€‚", å…ƒæ°—ã£å­: "ã‚„ã£ãŸãƒ¼ï¼ã©ã‚“ãªæ–™ç†ã«ãªã‚‹ã‹ãƒ¯ã‚¯ãƒ¯ã‚¯ï¼", ãŠã£ã¨ã‚Š: "ã†ãµãµã€ç¾å‘³ã—ãã—ã¦ã¡ã‚‡ã†ã ã„ã­ã‡ã€‚", è¬ã‚ã„ãŸ: "ãƒ•ãƒ•â€¦æ–°ãŸãªå½¢ã¨ãªã‚‹æ™‚ãŒæ¥ãŸã‹ã€‚", çš®è‚‰å±‹: "ã‚„ã£ã¨ã‹ã„ã€‚å¾…ã¡ããŸã³ã‚ŒãŸã‚ˆã€‚", ç„¡å£: "â€¦é ¼ã‚€ã€‚" }[style] || "ã‚ã‚ŠãŒã¨ã†ï¼";
        return `${name}ï¼šã€Œ${message}ã€`;
    }
    function getFarewellMessage(name, type) {
        const style = Array.isArray(personalities[type]) ? personalities[type][Math.floor(Math.random() * personalities[type].length)] : personalities[type] || "æ™®é€š";
        const message = { ç†±è¡€æ¼¢: "æœ€å¾Œã¾ã§æˆ¦ãˆãªãã¦â€¦ã™ã¾ã‚“â€¦ï¼", ã‚¯ãƒ¼ãƒ«: "ã“ã‚ŒãŒé‹å‘½ã‹â€¦ä»•æ–¹ãªã„ã€‚", ç¹Šç´°: "ã”ã€ã”ã‚ã‚“ãªã•ã„â€¦å½¹ã«ç«‹ã¦ãªãã¦â€¦", ãƒã‚¬ãƒ†ã‚£ãƒ–: "ã‚„ã£ã±ã‚Šã“ã†ãªã‚‹é‹å‘½ã ã£ãŸã‚“ã â€¦ã€‚", å…ƒæ°—ã£å­: "ãƒã‚¤ãƒãƒ¼ã‚¤ï¼ã¾ãŸã©ã“ã‹ã§ä¼šãŠã†ã­ï¼", ãŠã£ã¨ã‚Š: "ã‚ã‚‰ã‚ã‚‰ã€ä»•æ–¹ãªã„ã‚ã­ã‡â€¦ã•ã‚ˆã†ãªã‚‰ã€‚", è¬ã‚ã„ãŸ: "æ¶ˆãˆã‚‹ã®ã§ã¯ãªã„ã€‚é‚„ã‚‹ã ã‘ã ã€‚", çš®è‚‰å±‹: "ã‚„ã£ã±ã‚Šã­ã€‚æœŸå¾…ã—ã¦æã—ãŸã‚ˆã€‚", ç„¡å£: "â€¦â€¦ã•ã‚‰ã°ã ã€‚" }[style] || "ã•ã‚ˆã†ãªã‚‰â€¦";
        return `${name}ï¼šã€Œ${message}ã€`;
    }

    function saveToDiary(item, status, finalDialog) {
        const diary = JSON.parse(localStorage.getItem("diary") || "[]");
        const log = {
            name: item.name, addDate: item.addDate, expiry: item.expiry, status: status,
            processedDate: new Date().toISOString(), initialDialog: item.initialDialog,
            finalDialog: finalDialog, userImage: item.userImage, type: item.type
        };
        diary.unshift(log);
        localStorage.setItem("diary", JSON.stringify(diary));
    }
    
    function displayIngredients() {
      const list = document.getElementById("ingredient-list");
      list.innerHTML = "";
      const ingredients = JSON.parse(localStorage.getItem("ingredients") || "[]");
      ingredients.forEach((item) => {
        const card = document.createElement("div");
        card.className = "card";
        const daysLeft = getDaysLeft(item.expiry);
        if (daysLeft < 0) card.classList.add("expired");
        else if (daysLeft <= 3) card.classList.add("near-expiry");
        const img = document.createElement("img");
        img.src = item.userImage || `ã‚¤ãƒ©ã‚¹ãƒˆ/${item.type}.png`;
        img.onerror = () => { img.src = `ã‚¤ãƒ©ã‚¹ãƒˆ/other.png`; };
        const text = document.createElement("p");
        text.innerHTML = `<strong>${item.name}</strong><br>æœŸé™: ${item.expiry}`;
        const dialog = document.createElement("p");
        dialog.className = "dialog";
        dialog.textContent = generateDialog(item.name, item.type, daysLeft);
        const btnContainer = document.createElement("div");
        const cookBtn = document.createElement("button"); cookBtn.textContent = "ğŸ³ æ–™ç†ã™ã‚‹";
        cookBtn.onclick = () => {
            const msg = getGratitudeMessage(item.name, item.type); showToast(msg);
            saveToDiary(item, "èª¿ç†", msg);
            const current = JSON.parse(localStorage.getItem("ingredients") || "[]");
            const filtered = current.filter(i => i.addDate !== item.addDate);
            localStorage.setItem("ingredients", JSON.stringify(filtered));
            displayIngredients(); displayDiary();
        };
        const expireBtn = document.createElement("button"); expireBtn.textContent = "ğŸ—‘ï¸ æœŸé™åˆ‡ã‚Œå‡¦ç†";
        expireBtn.onclick = () => {
            const msg = getFarewellMessage(item.name, item.type); showToast(msg);
            saveToDiary(item, "å»ƒæ£„", msg);
            const current = JSON.parse(localStorage.getItem("ingredients") || "[]");
            const filtered = current.filter(i => i.addDate !== item.addDate);
            localStorage.setItem("ingredients", JSON.stringify(filtered));
            displayIngredients(); displayDiary();
        };
        btnContainer.appendChild(cookBtn); btnContainer.appendChild(expireBtn);
        card.appendChild(img); card.appendChild(text); card.appendChild(dialog); card.appendChild(btnContainer);
        list.appendChild(card);
      });
    }

    function displayDiary() {
        const diaryContainer = document.getElementById("diary-summary");
        diaryContainer.innerHTML = "";
        const diary = JSON.parse(localStorage.getItem("diary") || "[]");
        if (diary.length === 0) {
            diaryContainer.innerHTML = "<p>æ—¥è¨˜ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>"; return;
        }
        const sortType = document.getElementById('sort-diary').value;
        if (sortType === 'type') {
            const typeOrder = { "vegetable": 1, "meat": 2, "fish": 3, "egg": 4, "dairy": 5, "snack": 6, "other": 7 };
            const groupedByType = diary.reduce((acc, log) => {
                if (!acc[log.type]) acc[log.type] = [];
                acc[log.type].push(log);
                return acc;
            }, {});
            Object.keys(groupedByType).sort((a,b) => (typeOrder[a]||99) - (typeOrder[b]||99)).forEach(type => {
                const heading = document.createElement("h3");
                heading.className = "diary-group-heading";
                const typeText = document.querySelector(`#type option[value=${type}]`).textContent;
                heading.innerHTML = `<img src="ã‚¤ãƒ©ã‚¹ãƒˆ/${type}.png" onerror="this.src='ã‚¤ãƒ©ã‚¹ãƒˆ/other.png'"> <span>${typeText}</span>`;
                diaryContainer.appendChild(heading);
                groupedByType[type]
                    .sort((a,b) => new Date(b.processedDate) - new Date(a.processedDate))
                    .forEach(log => diaryContainer.appendChild(createDiaryEntry(log)));
            });
        } else { // processedDate
            [...diary]
                .sort((a,b) => new Date(b.processedDate) - new Date(a.processedDate))
                .forEach(log => diaryContainer.appendChild(createDiaryEntry(log, true)));
        }
    }
    
    function createDiaryEntry(log, showDateInSummary = false) {
        const details = document.createElement("details");
        const summary = document.createElement("summary");
        const processDate = new Date(log.processedDate).toLocaleDateString();
        summary.textContent = showDateInSummary ? `${log.name}ï¼ˆ${processDate}ï¼‰` : log.name;
        details.appendChild(summary);
        const entry = document.createElement("div");
        entry.className = "log-entry";
        const img = document.createElement("img");
        img.src = log.userImage || `ã‚¤ãƒ©ã‚¹ãƒˆ/${log.type}.png`;
        img.onerror = () => { img.src = `ã‚¤ãƒ©ã‚¹ãƒˆ/other.png`; };
        const logDetails = document.createElement("div");
        logDetails.className = "log-details";
        const statusText = log.status === 'èª¿ç†' ? 'èª¿ç†' : 'å»ƒæ£„';
        const statusClass = log.status === 'èª¿ç†' ? 'cooked' : 'disposed';
        const initialDialogText = log.initialDialog || `${log.name || 'ã“ã®å­'}ï¼šã€Œè¨˜éŒ²ãªã—ã€`;
        const finalDialogText = log.finalDialog || `${log.name || 'ã“ã®å­'}ï¼šã€Œè¨˜éŒ²ãªã—ã€`;
        logDetails.innerHTML = `
            <table class="diary-table">
              <thead><tr><th>å‡¦ç†æ—¥</th><th>ç™»éŒ²æ—¥</th><th>æœŸé™æ—¥</th><th>çµæœ</th></tr></thead>
              <tbody><tr>
                <td>${new Date(log.processedDate).toLocaleString()}</td>
                <td>${new Date(log.addDate).toLocaleDateString()}</td>
                <td>${log.expiry}</td>
                <td><span class="status-dot ${statusClass}">â—</span> ${statusText}</td>
              </tr></tbody>
            </table>
            <div class="diary-conversation">
              <p class="dialog-title">ä¼šè©±ãƒ­ã‚°</p>
              <p class="dialog-line"><span class="dialog-label">ç™»å ´</span>${initialDialogText}</p>
              <p class="dialog-line"><span class="dialog-label">çµæœ«</span>${finalDialogText}</p>
            </div>`;
        entry.appendChild(img); entry.appendChild(logDetails);
        details.appendChild(entry);
        return details;
    }

    function displayAnalytics() {
        const diary = JSON.parse(localStorage.getItem("diary") || "[]");
        if (trendChartInstance) trendChartInstance.destroy();
        if (typeStatsChartInstance) typeStatsChartInstance.destroy();

        if(diary.length === 0) {
            document.getElementById('avg-processing-time').textContent = '- æ—¥';
            // Also clear charts if no data
            const trendCtx = document.getElementById('trend-chart').getContext('2d');
            trendChartInstance = new Chart(trendCtx, { type: 'line', data: { labels: [], datasets: [] }, options: {} });
            const typeCtx = document.getElementById('type-stats-chart').getContext('2d');
            typeStatsChartInstance = new Chart(typeCtx, { type: 'bar', data: { labels: [], datasets: [] }, options: {} });
            return;
        }

        const validLogs = diary.filter(log => log.addDate && log.processedDate && !isNaN(new Date(log.addDate)) && !isNaN(new Date(log.processedDate)));
        let totalDays = 0;
        validLogs.forEach(log => {
            totalDays += (new Date(log.processedDate) - new Date(log.addDate)) / 86400000;
        });
        const avgDays = validLogs.length > 0 ? (totalDays / validLogs.length).toFixed(1) : 0;
        document.getElementById('avg-processing-time').textContent = `${avgDays} æ—¥`;
        
        updateTrendChart();

        const typeStats = {};
        const typeNames = {};
        document.querySelectorAll('#type option').forEach(opt => {
            typeStats[opt.value] = { cooked: 0, disposed: 0 };
            typeNames[opt.value] = opt.textContent;
        });
        diary.forEach(log => {
            if(!typeStats[log.type]) return;
            if(log.status === 'èª¿ç†') typeStats[log.type].cooked++;
            else typeStats[log.type].disposed++;
        });
        const typeCtx = document.getElementById('type-stats-chart').getContext('2d');
        typeStatsChartInstance = new Chart(typeCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(typeStats).map(key => typeNames[key]),
                datasets: [
                    { label: 'èª¿ç†', data: Object.values(typeStats).map(s => s.cooked), backgroundColor: 'rgba(40, 167, 69, 0.7)' },
                    { label: 'å»ƒæ£„', data: Object.values(typeStats).map(s => s.disposed), backgroundColor: 'rgba(220, 53, 69, 0.7)' }
                ]
            },
            options: { indexAxis: 'y', scales: { x: { stacked: true, ticks: { stepSize: 1, precision: 0 } }, y: { stacked: true } } }
        });
    }

    function updateTrendChart() {
        const diary = JSON.parse(localStorage.getItem("diary") || "[]");
        const period = document.getElementById('trend-period').value;
        const dataMap = new Map();
        const labels = [];
        const today = new Date();
        today.setHours(0,0,0,0); // ä»Šæ—¥ã®æ—¥ä»˜ã‚’åˆå‰0æ™‚ã«è¨­å®š

        if (period === '7days' || period === '30days') {
            const days = period === '7days' ? 7 : 30;
            for (let i = days - 1; i >= 0; i--) { // éå»Næ—¥é–“ã‚’é€†é †ã«ç”Ÿæˆ (ä»Šæ—¥ã‹ã‚‰ã•ã‹ã®ã¼ã‚‹)
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateString = date.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric'});
                labels.push(dateString);
                dataMap.set(date.toISOString().split('T')[0], 0); // YYYY-MM-DD å½¢å¼ã§ã‚­ãƒ¼ã‚’ä¿å­˜
            }
            diary.forEach(log => {
                const logDate = new Date(log.processedDate);
                logDate.setHours(0,0,0,0); // ãƒ­ã‚°ã®æ—¥ä»˜ã‚‚åˆå‰0æ™‚ã«è¨­å®š
                const logDateString = logDate.toISOString().split('T')[0];
                if (dataMap.has(logDateString)) {
                    dataMap.set(logDateString, dataMap.get(logDateString) + 1);
                }
            });
        } else { // byMonth
            for (let i = 11; i >= 0; i--) { // éå»12ãƒ¶æœˆã‚’é€†é †ã«ç”Ÿæˆ
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthString = `${date.getFullYear()}/${date.getMonth() + 1}`;
                labels.push(monthString);
                dataMap.set(monthString, 0);
            }
            diary.forEach(log => {
                const logDate = new Date(log.processedDate);
                const monthString = `${logDate.getFullYear()}/${logDate.getMonth() + 1}`;
                if (dataMap.has(monthString)) {
                    dataMap.set(monthString, dataMap.get(monthString) + 1);
                }
            });
        }
        
        const trendCtx = document.getElementById('trend-chart').getContext('2d');
        if (trendChartInstance) trendChartInstance.destroy();
        trendChartInstance = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'å‡¦ç†æ•°',
                    data: [...dataMap.values()], // Mapã®å€¤ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    backgroundColor: 'rgba(255, 127, 80, 0.2)',
                    borderColor: 'rgba(255, 127, 80, 1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true
                }]
            },
            options: { 
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        ticks: { stepSize: 1, precision: 0 } 
                    } 
                } 
            }
        });
    }

    const modal = document.getElementById('confirm-modal');
    function showClearConfirmModal() { modal.classList.add('show'); }
    function hideClearConfirmModal() { modal.classList.remove('show'); }
    document.getElementById('modal-confirm-btn').onclick = () => {
        localStorage.removeItem("diary");
        localStorage.removeItem("ingredients");
        displayDiary(); displayIngredients();
        hideClearConfirmModal();
        showToast("ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    };
    document.getElementById('modal-cancel-btn').onclick = hideClearConfirmModal;
    modal.onclick = (e) => { if(e.target === modal) hideClearConfirmModal(); };
    
    const addBtn = document.getElementById("add-btn");
    const dropZone = document.getElementById("drop-zone");
    addBtn.addEventListener("click", () => {
        const name = document.getElementById("name").value.trim();
        const type = document.getElementById("type").value;
        const expiry = document.getElementById("expiry").value;
        if (!name || !type || !expiry) {
            showToast("ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error"); return;
        }
        const ingredients = JSON.parse(localStorage.getItem("ingredients") || "[]");
        const addDate = new Date().toISOString();
        const initialDialog = generateDialog(name, type, getDaysLeft(expiry));
        const newIngredient = { name, type, expiry, addDate, initialDialog, userImage: droppedImageData };
        ingredients.push(newIngredient);
        localStorage.setItem("ingredients", JSON.stringify(ingredients));
        displayIngredients();
        showToast(`ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`);
        document.getElementById("name").value = "";
        document.getElementById("expiry").value = "";
        droppedImageData = null;
        dropZone.textContent = "ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—";
    });

    dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("dragover"); });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
    dropZone.addEventListener("drop", e => {
        e.preventDefault();
        dropZone.classList.remove("dragover");
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onloadend = () => {
                droppedImageData = reader.result;
                dropZone.innerHTML = `âœ… <strong>ã€Œ${file.name}ã€</strong>ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ`;
                showToast("ç”»åƒã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼");
            };
            reader.readAsDataURL(file);
        } else { showToast("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", "error"); }
    });
    
    window.onload = () => {
        showPage('home');
        if (document.getElementById("nav-menu").classList.contains("open")) { toggleMenu(); }
        displayIngredients();
        displayDiary();
    };
  </script>
</body>
</html>